<!DOCTYPE html>
<html lang="en">
<head>

    <!-- Meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta content="AliExprass" name="author">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Exclusively for all! Take advantage of up to -50% on these offers during our smart days. Shop smart with discounts on electronics, phones and home goods. Up to -50% Buyer Protection. Free Shipping. Summer promo. Great Value. A multitude of sellers.">
    <meta name="keywords" content="">

    <title>AliExprass - Shopping</title>
    <link rel="shortcut icon" type="image/x-icon" href="assets/images/favicon.png">

    <link rel="stylesheet" href="assets/style.css">

</head>

<body>
{% include "partials/header.html.twig" %}


{% block body %}
    <div class="section">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="table-responsive shop_cart_table">
                        <table class="table" id="cart-table">
                            <thead>
                            <tr class="title-top">
                                <th class="product-thumbnail">Image</th>
                                <th class="product-name">Product</th>
                                <th class="product-price">Price TND</th>
                                <th class="product-quantity">Quantity</th>
                                <th class="product-subtotal">Total</th>
                                <th class="product-remove">Remove</th>

                            </tr>
                            </tr>
                            </thead>

                        </table>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <div class="medium_divider"></div>
                    <div class="divider center_icon"><i class="ti-shopping-cart-full"></i></div>
                    <div class="medium_divider"></div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">


                </div>
                <div class="col-md-6">
                    <div class="border p-3 p-md-4">
                        <a href="#" class="btn btn-fill-out" onclick="passOrder()">finaliser votre commande</a>


                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}



{% block javascripts %}
    <script>

        const idd = document.getElementById("session");
        let cartDetails = JSON.parse(sessionStorage.getItem('cart'));
        console.table(cartDetails);
        let container = $('#cart-table');
        let img = "";
        let imgFinal = "";
        let totalPrice = 0;
        let productsList = [];

        cartDetails.forEach((e) => {
            productsList.push(e);
            totalPrice += (e.price * e.desiredQuantity);
            Quantity = e.desiredQuantity;
            img = "{{ asset('#') }}";
            imgFinal = img.replace("#", e.image);
            container.append("<tr id=\"singleline" + e.id + "\" >\n" +
                "<td class=\"product-thumbnail\"><a href=\"#\"><img src=\"" + imgFinal + "\" alt=\"product img\" /></a></td>\n" +
                "<td class=\"product-name\"><a href=\"#\">" + e.nom + "</a></td>\n" +
                "<td class=\"product-price\"><span class=\"amount\" id=\"price" + e.id + "\"  >" + e.price + "</span></td>\n" +
                "<td class=\"product-quantity\">" +
                "<input type=\"number\" value=\"" + e.desiredQuantity + "\" id=\"row" + e.id + "\" " +
                "onchange='changeQuantity(" + e.id + ")' /></td>\n" +
                "<td class=\"product-subtotal\" id=\"total" + e.id + "\" >" + e.price * e.desiredQuantity + "</td>\n" +
                "<td>\n" +
                "<button class=\"cartbox__item__remove\" onclick=\" deleteItem(" + e.id + ")\">\n" +
                "<i class=\"fa fa-trash\"></i>\n" +
                "</button>\n" +
                "</td>\n" +
                "<div class=\"cart__total__amount\" ><span class=\"amount\">" + totalPrice + "</span></div>\n" +

                "</tr>"
            );

        });


        function passOrder() {
            console.log(cartDetails);

            let url = "{{ path('createOrderAjax') }}";
            console.log(typeof cartDetails);
            console.log(cartDetails);
            let params = {total: totalPrice, products: productsList, pro: 1};
            xhrFields: {
                responseType: 'blob'
            }
            let successCallback = (data) => {
                alert("success");
            };
            let completeCallback = (data) => {
                alert('completed')
            };
            makeAjaxCall(url, "POST", params, successCallback, null, completeCallback);
        }

        function changeQuantity(id) {
            let placeholder = $('#total' + id);
            let value = Number.parseInt(placeholder.text());
            let product = productsList.find((e) => e.id === id);
            if (product !== undefined) {
                let updatedQuantity = $("#row" + id);
                value = Number.parseInt(updatedQuantity.val()) * product.price;
                placeholder.text(value);
                cartDetails[cartDetails.indexOf(product)].desiredQuantity = Number.parseInt(updatedQuantity.val());
                updateTotalPrice();
                console.log(totalPrice);
                console.table(cartDetails);

            }


        }

        function deleteItem(id) {
            product = cartDetails.find((e) => e.id === id)
            if (product !== undefined) {
                cartDetails.splice(cartDetails.indexOf(product), 1);
                let item = $('#singleline'+id);
                item.remove();
                updateTotalPrice();
            }

        }

        function updateTotalPrice() {
            totalPrice = 0;
            cartDetails.forEach((e) => {
                totalPrice += (e.price * e.desiredQuantity);
            })
        }


    </script>
{% endblock %}

<script src="assets/js/jquery-1.12.4.min.js"></script>
<script src="assets/js/popper.min.js"></script>
<script src="assets/bootstrap/js/bootstrap.min.js"></script>
<script src="assets/owlcarousel/js/owl.carousel.min.js"></script>
<script src="assets/js/magnific-popup.min.js"></script>
<script src="assets/js/waypoints.min.js"></script>
<script src="assets/js/parallax.js"></script>
<script src="assets/js/jquery.countdown.min.js"></script>
<script src="assets/js/imagesloaded.pkgd.min.js"></script>
<script src="assets/js/isotope.min.js"></script>
<script src="assets/js/jquery.dd.min.js"></script>
<script src="assets/js/slick.min.js"></script>
<script src="assets/js/jquery.elevatezoom.js"></script>
<script src="assets/js/scripts.js"></script>

{% include "partials/footer.html.twig" %}

</body>

</html>

